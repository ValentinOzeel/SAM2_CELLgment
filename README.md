# CellGment: Cell Segmentation with SAM2

CellGment is an advanced tool designed for the segmentation of cells in microscopy images, utilizing the capabilities of the Segment Anything Model 2 (SAM2). This project integrates traditional image processing techniques with cutting-edge deep learning methodologies. It is highly customizable, expendable and can be easily adapted to various microscopy images.

## Introduction

In the realm of biological research, accurately identifying and segmenting cells from microscopy images is crucial for various applications. Traditional image processing methods often struggle various limitations leading to inaccurate results.

CellGment addresses these challenges by combining robust preprocessing techniques with the powerful SAM2 model, which excels in generating high-quality segmentation masks. The pipeline is designed to be user-friendly, allowing researchers to easily process their images and obtain reliable segmentation results. With CellGment, users can easily detect and segment cells in their microscopy images.

## Examples

Here are some examples of the masks generated by CellGment on different microscopy images of HeLa cells with various cell densities, stainings and sizes.
These images showcase the progression from raw input to final segmentation results, demonstrating the effectiveness of the CellGment pipeline in accurately identifying and segmenting individual cells (and comparing SAM2AutomaticMaskGenerator with SAM2ImagePredictor + prompts).

![First Set of Masks](https://github.com/ValentinOzeel/SAM2_CELLgment/blob/main/src/first-set.png)

![Second Set of Masks](https://github.com/ValentinOzeel/SAM2_CELLgment/blob/main/src/second-set.png)

![Third Set of Masks](https://github.com/ValentinOzeel/SAM2_CELLgment/blob/main/src/third-set.png)


## Features

- **Image Preprocessing**: 
  - Noise reduction through Gaussian blur and contrast enhancement using CLAHE (Contrast Limited Adaptive Histogram Equalization).
  - Background illumination correction to improve cell visibility.
  - Morphological operations to refine binary images and remove small artifacts.

- **Cell Detection**:
  - Based on the preprocessed image
  - Automatic detection of individual and touching cells using connected component analysis and watershed segmentation.
  - Calculation of centroids and bounding boxes for each detected cell (serve as positive points/bounding boxes for SAM2).

- **Mask Generation**:
  - Integration with SAM2 for generating precise segmentation masks based on the preprocessed images or the raw image.
  - Support for both automatic mask generation and user-defined prompts (centroids or bounding boxes) for more controlled segmentation.

- **Visualization Tools**:
  - Comprehensive visualization functions to display raw images, preprocessing results, detected centroids, bounding boxes, and generated masks.
  - Ability to visualize results in a clear and informative manner, aiding in the interpretation of segmentation outcomes.

- **Flexible Configuration**:
  - A YAML configuration file allows users to customize various parameters of the pipeline, including preprocessing settings, detection thresholds, and SAM2 model parameters.

## Pipeline Overview

The CellGment pipeline consists of several key stages, each designed to enhance the accuracy and reliability of cell segmentation:

1. **Image Acquisition**:
   - Users provide a raw microscopy image, which serves as the input for the pipeline.

2. **Image Preprocessing**:
   - The raw image undergoes a series of preprocessing steps:
     - **Gaussian Blur**: Reduces noise while preserving important cell structures.
     - **CLAHE**: Enhances contrast in unevenly illuminated images, making cells more distinguishable.
     - **Background Correction**: Removes gradual illumination changes to isolate cells from the background.
     - **Binarization**: Converts the corrected image into a binary format, facilitating the detection of cell structures.

3. **Cell Detection**:
   - The preprocessed binary image is analyzed to detect individual cells and touching cells:
     - **Connected Component Analysis**: Labels connected regions in the binary image.
     - **Watershed Segmentation**: Separates touching cells by treating the distance transform of the labeled image as a topographic surface.

4. **Mask Generation with SAM2**:
   - The detected cell information and the preprocessed (or raw) image are fed into the SAM2 model:
     - **Automatic Mask Generation**: SAM2 generates masks for each detected cell, providing high-quality segmentation results.
     - **Predictor Masks**: Users can provide prompts (centroids or bounding boxes computed before) to refine the mask generation process.

5. **Visualization**:
   - The results of the segmentation process are visualized using various plotting functions:
     - Raw images, preprocessing results, detected centroids, bounding boxes, and generated masks are displayed for easy interpretation.

6. **Output**:
   - The final output includes the segmented masks, centroids, and bounding boxes, which can be used for further analysis or exported for reporting.


## Installation

1. Install cuda (https://developer.nvidia.com/cuda-toolkit) and torch on GPU (https://pytorch.org/get-started/locally/)

2. Clone this repository:
   ```
   git clone https://github.com/ValentinOzeel/SAM2_CELLgment
   cd cellgment
   ```

3. Install the required dependencies:
   ```
   pip install -r requirements.txt
   ```

4. SAM2 installation:
    Follow the instructions from the official [repository](https://github.com/facebookresearch/segment-anything-2?tab=readme-ov-file).
    Place the segment-anything-2 folder in the root of this repository.


## Usage

To use CellGment, run the main script:
`python src/main.py`

This will process the default image and display the results.

## Configuration

The project uses a YAML configuration file (`src/config.yaml`) to control various parameters of the pipeline. Key configuration sections include:

- **PREPROCESSING**: Controls image preprocessing steps.
- **CENTROIDS_POINTS_AND_BBOXES**: Parameters for cell detection.
- **CONTOUR_AND_BACKGROUND_POINTS**: Settings for contour and background point generation.
- **SAM2**: Settings for SAM2 model.

To modify the configuration, edit the `src/config.yaml` file.

## Contributing

Contributions to CellGment are welcome! Please feel free to submit a Pull Request.

## License

This project is licensed under the MIT License - see the LICENSE file for details.